<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Pousada Pedra Talhada</title>
    <link rel="stylesheet" href="../../../public/css/styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="../../../public/js/room-manager.js"></script>
    <style>
        /* Estilos espec√≠ficos da p√°gina de checkout */
        .sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100vh; background: #FFFFFF; padding: 20px; box-shadow: 2px 0 8px rgba(0,0,0,0.1); overflow-y: auto; }
        .brand { display: flex; align-items: center; gap: 10px; margin-bottom: 30px; }
        .logo-icon { font-size: 28px; color: #5D4037; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 16px; color: #666; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; margin-bottom: 10px; }
        .sidebar nav a:hover, .sidebar nav a.active { background: #F5F5F5; color: #5D4037; font-weight: 600; }
        .sidebar nav .material-icons-round { margin-right: 12px; font-size: 20px; }
        .logout-link { margin-top: 30px; border-top: 1px solid #E0E0E0; padding-top: 20px; color: #D32F2F; }    

        main { margin-left: 260px; padding: 30px; background: #F5F7FA; min-height: 100vh; }
        
        .page-header { margin-bottom: 30px; }
        .page-header h1 { margin: 0; font-size: 28px; color: #333; margin-bottom: 10px; }
        .breadcrumb { display: flex; gap: 10px; font-size: 12px; color: #666; }
        .breadcrumb a { color: #5D4037; text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }

        .checkout-container { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        
        .checkout-content { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .checkout-sidebar { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px; }

        .section { margin-bottom: 30px; }
        .section h2 { font-size: 18px; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #E0E0E0; }

        .info-group { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .info-item { }
        .info-item label { display: block; font-weight: 600; color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; }
        .info-item p { margin: 0; color: #333; font-size: 14px; }

        .consumptionTable { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .consumptionTable th { background: #F5F5F5; padding: 12px; text-align: left; font-weight: 600; color: #333; font-size: 12px; border-bottom: 2px solid #E0E0E0; }
        .consumptionTable td { padding: 12px; border-bottom: 1px solid #E0E0E0; color: #666; }
        .consumptionTable tr:hover { background: #FAFAFA; }
        .consumptionTable .text-right { text-align: right; }

        .addConsumption { display: grid; grid-template-columns: 1fr 100px 80px; gap: 10px; margin-top: 15px; }
        .addConsumption input, .addConsumption select { padding: 8px; border: 1px solid #E0E0E0; border-radius: 8px; font-size: 12px; }
        .addConsumption button { padding: 8px 16px; background: #00C853; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .addConsumption button:hover { background: #00AA4F; }

        .paymentMethod { margin-bottom: 20px; }
        .paymentOption { display: flex; align-items: center; margin-bottom: 12px; }
        .paymentOption input[type="radio"] { margin-right: 10px; cursor: pointer; }
        .paymentOption label { cursor: pointer; flex: 1; }

        .summaryBox { background: #F5F5F5; padding: 20px; border-radius: 8px; }
        .summaryItem { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; color: #666; }
        .summaryItem.total { font-weight: 700; font-size: 16px; color: #333; border-top: 2px solid #E0E0E0; padding-top: 12px; }
        .summaryItem span:last-child { font-weight: 600; }

        .checkoutActions { display: flex; gap: 15px; margin-top: 20px; }
        .btn { padding: 14px 28px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-blue { background: #1976D2; color: white; flex: 1; }
        .btn-primary:hover { background: #4E342E; }
        .btn-secondary { background: #BDBDBD; color: white; flex: 1; }
        .btn-secondary:hover { background: #9E9E9E; }
        .btn-danger { background: #FF3D00; color: white; }
        .btn-danger:hover { background: #E63200; }

        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert-success { background: #E8F5E9; color: #00C853; border-left: 4px solid #00C853; }
        .alert-warning { background: #FFF3E0; color: #FFAB00; border-left: 4px solid #FFAB00; }

        .notesBox { background: white; border: 1px solid #E0E0E0; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .notesBox textarea { width: 100%; border: none; resize: vertical; min-height: 80px; font-family: 'Inter', sans-serif; font-size: 12px; }

        .changeBox { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .changeItem { background: white; padding: 15px; border-radius: 8px; border: 1px solid #E0E0E0; }
        .changeItem label { display: block; font-size: 12px; color: #666; margin-bottom: 8px; }
        .changeItem input { width: 100%; padding: 8px; border: 1px solid #E0E0E0; border-radius: 8px; font-size: 14px; font-weight: 600; }

        /* Quando exibido em iframe no modal, esconda sidebar e remova margem esquerda */
        body.in-iframe .sidebar { display: none !important; }
        body.in-iframe .app-container { display: block; width: 100%; padding: 0; }
        body.in-iframe main { width: 100% !important; margin: 0 !important; padding: 20px !important; background: white !important; min-height: auto; box-sizing: border-box; display: block; }
        body.in-iframe .checkout-container { width: 100%; margin: 0; grid-template-columns: 1fr; gap: 20px; }
        body.in-iframe .checkout-content, body.in-iframe .checkout-sidebar { width: 100%; }
        body.in-iframe .checkout-sidebar { position: static; height: auto; }
        body.in-iframe .btn { font-size: 14px; padding: 12px 20px; }
        body.in-iframe .checkoutActions { display: flex; gap: 10px; margin-top: 15px; }
        body.in-iframe .page-header { margin-bottom: 15px; }
        body.in-iframe .page-header h1 { font-size: 20px; margin-bottom: 5px; }
        body.in-iframe .checkout-content, body.in-iframe .checkout-sidebar { padding: 20px; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; position: relative; margin-bottom: 20px; }
            main { margin-left: 0; padding: 15px; }
            .checkout-container { grid-template-columns: 1fr; }
            .checkout-sidebar { position: static; }
            .info-group { grid-template-columns: 1fr; }
            .addConsumption { grid-template-columns: 1fr; }
            .changeBox { grid-template-columns: 1fr; }
        }
    </style>
    <script>
        // Detecta se est√° dentro de iframe (modal) e aplica classe para esconder a sidebar
        document.addEventListener('DOMContentLoaded', function() {
            if (window.self !== window.top) {
                document.body.classList.add('in-iframe');
            }
        });
    </script>
</head>
<body>
    
    <div class="app-container">
        <aside class="sidebar">
            <div class="brand">
                <div class="logo-icon"><span class="material-icons-round">apartment</span></div>
                <div>
                    <strong>Pousada Pedra</strong><br>Talhada
                </div>
            </div>

            <nav>
                <a href="index.html"><span class="material-icons-round">dashboard</span> Dashboard</a>
                <a href="reservas.html" class="active"><span class="material-icons-round">description</span> Reservas</a>
                <a href="hospedes.html"><span class="material-icons-round">people</span> H√≥spedes</a>
                <a href="financeiro.html"><span class="material-icons-round">assessment</span> Financeiro</a>
                <a href="usuarios.html"><span class="material-icons-round">security</span> Equipe e Acessos</a>           
                <a href="login.html" class="logout-link">
                    <span class="material-icons-round">logout</span> Sair
                </a>
            </nav>
        </aside>

    <!-- CONTE√öDO PRINCIPAL -->
    <main>
        <div class="page-header">
            <h1>Checkout - Encerramento de Hospedagem</h1>
            <div class="breadcrumb">
                <a href="index.html">Dashboard</a>
                <span>/</span>
                <a href="reservas.html">Reservas</a>
                <span>/</span>
                <span>Checkout</span>
            </div>
        </div>

        <div class="alert alert-warning" id="alertBox">
            ‚ö†Ô∏è <strong>Aviso:</strong> Revise todos os dados antes de confirmar o checkout.
        </div>

        <form class="checkout-container" id="checkoutForm" onsubmit="submitCheckout(event)">
            <!-- CONTE√öDO PRINCIPAL -->
            <div class="checkout-content">
                <!-- INFORMA√á√ïES DA RESERVA -->
                <div class="section">
                    <h2>Informa√ß√µes da Reserva</h2>
                    <div class="info-group">
                        <div class="info-item">
                            <label>ID Reserva</label>
                            <p id="reservationId">#RES002</p>
                        </div>
                        <div class="info-item">
                            <label>Status</label>
                            <p><span style="background: #E3F2FD; color: #1976D2; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Hospedagem Ativa</span></p>
                        </div>
                    </div>
                </div>

                <!-- DADOS DO H√ìSPEDE -->
                <div class="section">
                    <h2>Dados do H√≥spede</h2>
                    <div class="info-group">
                        <div class="info-item">
                            <label>Nome</label>
                            <p id="guestName">Maria Santos</p>
                        </div>
                        <div class="info-item">
                            <label>CPF/RG</label>
                            <p id="guestDocument">123.456.789-00</p>
                        </div>
                    </div>
                    <div class="info-group">
                        <div class="info-item">
                            <label>E-mail</label>
                            <p id="guestEmail">maria@email.com</p>
                        </div>
                        <div class="info-item">
                            <label>Telefone</label>
                            <p id="guestPhone">(11) 99999-9999</p>
                        </div>
                    </div>
                </div>

                <!-- DETALHES DA HOSPEDAGEM -->
                <div class="section">
                    <h2>Detalhes da Hospedagem</h2>
                    <div class="info-group">
                        <div class="info-item">
                            <label>Quarto</label>
                            <p id="roomNumber">201</p>
                        </div>
                        <div class="info-item">
                            <label>Tipo de Quarto</label>
                            <p id="roomType">Duplo</p>
                        </div>
                    </div>
                    <div class="info-group">
                        <div class="info-item">
                            <label>Data de Entrada</label>
                            <p id="checkInDate">04/01/2026 - 14:00</p>
                        </div>
                        <div class="info-item">
                            <label>Data de Sa√≠da</label>
                            <p id="checkOutDate">07/01/2026 - 12:00</p>
                        </div>
                    </div>
                </div>

                <!-- CONSUMOS E TAXAS -->
                <div class="section">
                    <h2>Consumos e Taxas Adicionais</h2>
                    <table class="consumptionTable">
                        <thead>
                            <tr>
                                <th>Descri√ß√£o</th>
                                <th class="text-right">Quantidade</th>
                                <th class="text-right">Valor</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="consumptionBody">
                            <tr>
                                <td>Hospedagem (3 di√°rias)</td>
                                <td class="text-right">3</td>
                                <td class="text-right">R$ 250,00</td>
                                <td class="text-right"><strong>R$ 750,00</strong></td>
                            </tr>
                            <tr>
                                <td>Taxa de Servi√ßo (10%)</td>
                                <td class="text-right">1</td>
                                <td class="text-right">R$ 75,00</td>
                                <td class="text-right"><strong>R$ 75,00</strong></td>
                            </tr>
                            <tr>
                                <td>Minibar - Cerveja</td>
                                <td class="text-right">2</td>
                                <td class="text-right">R$ 15,00</td>
                                <td class="text-right"><strong>R$ 30,00</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="addConsumption">
                        <select id="consumptionType">
                            <option value="">-- Adicionar Consumo --</option>
                            <option value="minibar">Minibar</option>
                            <option value="room-service">Room Service</option>
                            <option value="laundry">Lavanderia</option>
                            <option value="phone">Telefone</option>
                            <option value="other">Outro</option>
                        </select>
                        <input type="number" id="consumptionQty" placeholder="Qtd" min="1" max="100">
                        <input type="number" id="consumptionPrice" placeholder="Valor" min="0" step="0.01">
                    </div>
                </div>

                <!-- OBSERVA√á√ïES -->
                <div class="section">
                    <h2>Observa√ß√µes e Avisos</h2>
                    <div class="notesBox">
                        <textarea id="notes" placeholder="Adicione observa√ß√µes, danos, reclama√ß√µes ou outras informa√ß√µes relevantes..." style="color: #666;"></textarea>
                    </div>
                </div>

                <!-- FORMA DE PAGAMENTO -->
                <div class="section">
                    <h2>Forma de Pagamento</h2>
                    <div class="paymentMethod">
                        <div class="paymentOption">
                            <input type="radio" name="paymentMethod" id="payment-cash" value="Dinheiro" checked>
                            <label for="payment-cash">
                                üíµ Dinheiro
                            </label>
                        </div>
                        <div class="paymentOption">
                            <input type="radio" name="paymentMethod" id="payment-card" value="Cart√£o">
                            <label for="payment-card">
                                üí≥ Cart√£o de Cr√©dito
                            </label>
                        </div>
                        <div class="paymentOption">
                            <input type="radio" name="paymentMethod" id="payment-debit" value="D√©bito">
                            <label for="payment-debit">
                                üè¶ Cart√£o de D√©bito
                            </label>
                        </div>
                        <div class="paymentOption">
                            <input type="radio" name="paymentMethod" id="payment-transfer" value="Transfer√™ncia">
                            <label for="payment-transfer">
                                üì± Transfer√™ncia Banc√°ria
                            </label>
                        </div>
                    </div>
                </div>

                <!-- TROCO -->
                <div class="section" id="changeSection" style="display: none;">
                    <h2>C√°lculo de Troco</h2>
                    <div class="changeBox">
                        <div class="changeItem">
                            <label>Valor Recebido</label>
                            <input type="number" id="receivedAmount" placeholder="0.00" min="0" step="0.01" onchange="calculateChange()">
                        </div>
                        <div class="changeItem">
                            <label>Troco</label>
                            <input type="text" id="changeAmount" readonly style="background: #E8F5E9; border-color: #00C853;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESUMO LATERAL -->
            <div class="checkout-sidebar">
                <h2 style="margin-bottom: 20px;">Resumo de Pagamento</h2>
                
                <div class="summaryBox">
                    <div class="summaryItem">
                        <span>Hospedagem (3 dias):</span>
                        <span id="hostingTotal">R$ 750,00</span>
                    </div>
                    <div class="summaryItem">
                        <span>Consumos:</span>
                        <span id="consumptionTotal">R$ 30,00</span>
                    </div>
                    <div class="summaryItem">
                        <span>Taxa de Servi√ßo:</span>
                        <span id="serviceTotal">R$ 75,00</span>
                    </div>
                    <div class="summaryItem">
                        <span>Descontos:</span>
                        <span id="discountTotal">R$ 0,00</span>
                    </div>
                    <div class="summaryItem total">
                        <span>TOTAL A PAGAR:</span>
                        <span id="finalTotal" style="color: #FF3D00;">R$ 855,00</span>
                    </div>
                </div>

                <div class="checkoutActions">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back();">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-blue">
                        <span class="material-icons-round">check</span> Confirmar Pagamento e Liberar Quarto
                    </button>
                </div>
            </div>
        </form>
    </main>

    <script>
        // Mostrar/ocultar campo de troco para pagamento em dinheiro
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const changeSection = document.getElementById('changeSection');
                if (this.value === 'Dinheiro') {
                    changeSection.style.display = 'block';
                } else {
                    changeSection.style.display = 'none';
                }
            });
        });

        function calculateChange() {
            const received = parseFloat(document.getElementById('receivedAmount').value) || 0;
            const total = parseFloat(document.getElementById('finalTotal').textContent.replace('R$ ', '').replace(',', '.')) || 0;
            const change = received - total;
            
            const changeInput = document.getElementById('changeAmount');
            if (change < 0) {
                changeInput.value = 'FALTA R$ ' + Math.abs(change).toFixed(2).replace('.', ',');
                changeInput.style.borderColor = '#FF3D00';
                changeInput.style.background = '#FFEBEE';
            } else {
                changeInput.value = 'R$ ' + change.toFixed(2).replace('.', ',');
                changeInput.style.borderColor = '#00C853';
                changeInput.style.background = '#E8F5E9';
            }
        }

        function submitCheckout(event) {
            event.preventDefault();

            const guestName = document.getElementById('guestName').textContent;
            const roomNumber = document.getElementById('roomNumber').textContent;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const notes = document.getElementById('notes').value;

            // Valida√ß√µes
            if (paymentMethod === 'Dinheiro') {
                const received = document.getElementById('receivedAmount').value;
                if (!received) {
                    alert('Por favor, informe o valor recebido');
                    return;
                }
            }

            // üîë LIBERAR O QUARTO NO GERENCIADOR
            if (window.RoomManager && typeof RoomManager.releaseRoom === 'function') {
                RoomManager.releaseRoom(roomNumber);
            }

            // Notificar janela pai (quando aberto em modal iframe) para atualizar dashboard
            try {
                if (window.top !== window.self && window.parent && window.parent.postMessage) {
                    window.parent.postMessage({ type: 'roomUpdated', room: roomNumber }, '*');
                }
            } catch (e) {
                // ignore cross-origin issues
            }

            // Simular envio
            alert(`Checkout confirmado!\n\nH√≥spede: ${guestName}\nQuarto: ${roomNumber} - LIBERADO\nForma de Pagamento: ${paymentMethod}\nTotal: R$ 855,00`);

            setTimeout(() => {
                // Fechar/voltar: se estiver em iframe, tente redirecionar o pai; caso contr√°rio, ir para index
                try {
                    if (window.top !== window.self && window.parent && window.parent.postMessage) {
                        // sinalizar ao pai que pode fechar o modal
                        window.parent.postMessage({ type: 'closeRoomModal', room: roomNumber }, '*');
                    }
                } catch (e) {}
                window.location.href = 'index.html';
            }, 800);
        }

        // Prefill room number from query param when opened in modal
        (function prefillRoomFromQuery() {
            try {
                const params = new URLSearchParams(window.location.search);
                const room = params.get('room');
                if (room) {
                    const roomEl = document.getElementById('roomNumber');
                    if (roomEl) roomEl.textContent = room;
                }
            } catch (e) {
                // ignore
            }
        })();
    </script>
    <script>
        // Ajuste de fallback para iframe
        (function adaptForIframe() {
            try {
                if (window.top !== window.self) {
                    document.body.classList.add('in-iframe');
                }
            } catch (e) {}
        })();
    </script>
</body>
</html>
