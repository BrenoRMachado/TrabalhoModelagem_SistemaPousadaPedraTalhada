<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Pousada Pedra Talhada</title>
    <link rel="stylesheet" href="../../../public/css/styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="../../../public/js/room-manager.js"></script>
</head>
<body>

    <div class="app-container">
        <aside class="sidebar">
            <div class="brand">
                <div class="logo-icon"><span class="material-icons-round">apartment</span></div>
                <div>
                    <strong>Pousada Pedra</strong><br>Talhada
                </div>
            </div>

            <nav>
                <a href="index.html" class="active"><span class="material-icons-round">dashboard</span> Dashboard</a>
                <a href="reservas.html"><span class="material-icons-round">description</span> Reservas</a>
                <a href="hospedes.html"><span class="material-icons-round">people</span> Hóspedes</a>
                <a href="financeiro.html"><span class="material-icons-round">assessment</span> Financeiro</a>
                <a href="usuarios.html"><span class="material-icons-round">security</span> Equipe e Acessos</a>              
                <a href="login.html" class="logout-link">
                    <span class="material-icons-round">logout</span> Sair
                </a>
            </nav>
        </aside>

        <main>
    <!-- Modal para abrir nova-reserva/checkout em iframe -->
    <div id="roomModal" class="modal">
        <div class="modal-content" style="width: 95%; max-width: 900px; height: 90%;">
            <div class="modal-header">
                <h2 id="roomModalTitle">Detalhes do Quarto</h2>
                <button class="modal-close" onclick="closeRoomModal()">×</button>
            </div>
            <iframe id="roomModalFrame" src="" style="width:100%; height: calc(100% - 72px); border: none; border-radius: 6px;"></iframe>
        </div>
    </div>

    <!-- Área principal do dashboard -->
    <div class="page-header" style="padding: 20px 0 10px 0;">
        <h1 style="margin:0;">Dashboard</h1>
    </div>

    <section class="room-grid" id="roomGrid" style="padding-bottom:40px;"></section>

    <script>
        // Renderizar quartos dinamicamente e adicionar click handler
        function renderRooms() {
            const roomGrid = document.getElementById('roomGrid');
            const rooms = RoomManager.getAllRooms();

            roomGrid.innerHTML = '';

            Object.keys(rooms).sort().forEach(roomNumber => {
                const room = rooms[roomNumber];
                const statusClass = RoomManager.getStatusClass(room.status);
                const statusIcon = RoomManager.getStatusIcon(room.status);
                const statusText = RoomManager.getStatusText(room.status);
                const guestInfo = room.guest || room.type;

                const roomCard = document.createElement('div');
                roomCard.className = `card ${statusClass}`;
                roomCard.setAttribute('data-room', roomNumber);
                roomCard.innerHTML = `
                    <div class="card-header">
                        <span class="material-icons-round">${statusIcon}</span>
                        <span>${statusText}</span>
                    </div>
                    <div class="room-num">${roomNumber}</div>
                    <div class="guest-info">${guestInfo}</div>
                `;

                // Clique abre modal com nova-reserva (se disponível) ou checkout (se ocupado)
                if (room.status === RoomManager.STATUS.AVAILABLE) {
                    roomCard.addEventListener('click', function() {
                        const rn = this.getAttribute('data-room');
                        openRoomModal('nova-reserva.html?room=' + rn, `Nova Reserva - Quarto ${rn}`);
                    });
                } else if (room.status === RoomManager.STATUS.OCCUPIED) {
                    roomCard.addEventListener('click', function() {
                        const rn = this.getAttribute('data-room');
                        openRoomModal('checkout.html?room=' + rn, `Checkout - Quarto ${rn}`);
                    });
                } else if (room.status === RoomManager.STATUS.MAINTENANCE) {
                    // Não permitir clique quando em manutenção
                    roomCard.classList.add('disabled');
                    roomCard.setAttribute('title', 'Em manutenção');
                    roomCard.style.cursor = 'not-allowed';
                }

                roomGrid.appendChild(roomCard);
            });
        }

        function openRoomModal(src, title) {
            document.getElementById('roomModalFrame').src = src;
            document.getElementById('roomModalTitle').textContent = title;
            document.getElementById('roomModal').classList.add('show');
        }

        function closeRoomModal() {
            const frame = document.getElementById('roomModalFrame');
            frame.src = '';
            document.getElementById('roomModal').classList.remove('show');
            // Re-render rooms to reflect any changes (ex: reserva/checkout)
            setTimeout(renderRooms, 200);
        }

        // Escuta mensagens de iframes filhos para atualizar ou fechar modal
        window.addEventListener('message', (event) => {
            const data = event.data || {};
            if (data.type === 'roomUpdated') {
                renderRooms();
            } else if (data.type === 'closeRoomModal') {
                closeRoomModal();
            }
        });

        // Renderizar ao carregar a página
        document.addEventListener('DOMContentLoaded', renderRooms);
    </script>

</body>
</html>